export default {
    data() {
        return {
            tableData: [],
            dialogVisible: false,
            deleteVisiable: false,
            id:0,
            newName: "",
            newLevel: 1,
            newDes: "",
            yjwx:[],
            rjwx:[],
            aid:0,
            tid:0,
        }
    },
    mounted() {
        this.getData();
        this.rjgl = JSON.parse(localStorage.rjgl);
        this.rjgl.forEach(async(item) => {
            const res = await this.$http.get("Asset/getBusinessappasset",{params:{id:item.id}});
            res.data[0].businessappthreatens.forEach( item => {
                this.rjwx.push({
                    id:item.id,
                    assetName:item.assetName,
                    threaten:item.threaten,
                    apartment:item.apartment,
                    importanceLevel:item.importanceLevel,
                });
            });
        });
        this.yjgl = JSON.parse(localStorage.yjgl);
        this.yjgl.forEach(async(item) => {
            const res = await this.$http.get("Asset/getHardwareasset",{params:{id:item.id}});
            res.data[0].hardwarethreatens.forEach( item => {
                this.yjwx.push({
                    id:item.id,
                    assetName:item.assetName,
                    dutyMan:item.dutyMan,
                    appDescription:item.appDescription,
                    importanceLevel:item.importanceLevel,
                    apartment:item.apartment
                });
            });
        });
        this.rjwx.push({
            id:0,
            assetName:"请选择对应软件威胁"
        });
        this.yjwx.push({
            id:0,
            assetName:"请选择对应硬件威胁"
        });
    },
    methods: {
        checkDataPass() {
            if(this.newName == "" || this.newDes =="")
            {
                return false;
            }
            if(this.id == 0 && (this.aid == 0 || this.tid == 0))
            {
                return false;
            }
            return true;
        },
        async getData() {
            const id = localStorage.object;
            const res = await this.$http.get("Vulnerable/getAllVulnerable",{params:{id}});
            this.tableData = res.data;
            localStorage.crx = JSON.stringify(this.tableData);
            if(this.tableData.length != 0)
            {
                localStorage.pass5 = "true";
            }
            else
            {
                localStorage.pass5 = "false";
            }
            this.$emit("changeShow");
        },
        async change(row){  
            this.dialogVisible = true;
            this.newName = row.assetName;
            this.newDes = row.objectDescription;
            this.newLevel = row.importantLevel;
            this.id = row.id;
        },
        check(row){
            this.id = row.id;
            this.deleteVisiable = true;
        },
        async remove() {
            await this.$http.delete("Vulnerable/DeleteVulnerable",{params:{id:this.id}});
            this.deleteVisiable = false;
            this.$message({
                type: "success",
                message: "删除成功！"
            });
            this.id = 0;
        },
        async add(){
            if(!this.checkDataPass())
            {
                this.$message({
                    type: "warning",
                    message: "存在必填项数据为空!"
                });
                return ;
            }
            const newObj = !this.id ? {
                aid: this.aid,
                tid: this.tid,
                objectName: this.newName,
                objectDescription: this.newDes,
                importantLevel: this.newLevel,
            } : {
                id: this.id,
                objectName: this.newName,
                objectDescription: this.newDes,
                importantLevel: this.newLevel,
            };
            !this.id ? await this.$http.post("Vulnerable/InsertVulnerable",newObj) : await this.$http.post("Vulnerable/UpdateVulnerable", newObj); 
            this.dialogVisible = false;
            this.$message({
                type:"success",
                message:"添加成功",
            });
            this.newName = "";
            this.newDes = "";
            this.getData();
        }
    },
}